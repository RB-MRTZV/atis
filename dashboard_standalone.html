<!DOCTYPE html>
<html>
<head>
    <title>AWS Cost Analysis Dashboard</title>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #232f3e 0%, #37474f 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dashboard-title::before {
            content: 'üìä';
            font-size: 32px;
        }
        
        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main-controls {
            background-color: white;
            padding: 25px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #232f3e;
        }
        
        .control-group select, .control-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #ff9900;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #ff9900;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #e68900;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .dashboard-content {
            margin: 20px;
        }
        
        .summary-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card h3 {
            color: #232f3e;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .summary-card .amount {
            font-size: 32px;
            font-weight: bold;
            color: #ff9900;
            margin-bottom: 8px;
        }
        
        .summary-card .label {
            color: #666;
            font-size: 14px;
        }
        
        .charts-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .data-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background-color: #232f3e;
            color: white;
            padding: 20px;
        }
        
        .table-header h3 {
            margin: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #232f3e;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
        }
        
        th:hover {
            background-color: #e9ecef;
        }
        
        th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }
        
        th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading::before {
            content: '‚è≥';
            font-size: 24px;
            margin-right: 10px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .account-badge {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .service-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .service-badge.EC2 {
            background-color: #FF9900;
        }
        
        .service-badge.RDS {
            background-color: #146EB4;
        }
        
        .service-badge.EKS {
            background-color: #232F3E;
        }
        
        .service-badge.ELB {
            background-color: #43A047;
        }
        
        .service-badge.S3 {
            background-color: #9C27B0;
        }
        
        .service-badge.Lambda {
            background-color: #FF5722;
        }
        
        .service-badge.default {
            background-color: #757575;
        }
        
        .environment-badge {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-overview {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-header">
        <h1 class="dashboard-title">AWS Cost Analysis Dashboard</h1>
        <p class="dashboard-subtitle">Multi-account cost analysis and optimization insights</p>
    </div>

    <div class="main-controls">
        <div class="controls-grid">
            <div class="control-group">
                <label for="accountFilter">Account View:</label>
                <select id="accountFilter">
                    <option value="all">All Accounts (Aggregated)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="serviceFilter">Service Filter:</label>
                <select id="serviceFilter">
                    <option value="all">All Services</option>
                    <option value="EC2">EC2</option>
                    <option value="RDS">RDS</option>
                    <option value="EKS">EKS</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="environmentFilter">Environment Filter:</label>
                <select id="environmentFilter">
                    <option value="all">All Environments</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="costThreshold">Min Monthly Cost ($):</label>
                <input type="number" id="costThreshold" min="0" step="0.01" placeholder="0.00">
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="loadDashboardData()">Refresh Data</button>
            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
            <button class="btn btn-secondary" onclick="exportData()">Export CSV</button>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="loading" id="loadingIndicator">
            Loading account data...
        </div>
        
        <div id="dashboardData" class="hidden">
            <div class="summary-overview">
                <div class="summary-card">
                    <h3>Total Monthly Cost</h3>
                    <div class="amount" id="totalMonthlyCost">$0.00</div>
                    <div class="label">Across all accounts</div>
                </div>
                <div class="summary-card">
                    <h3>Total Accounts</h3>
                    <div class="amount" id="totalAccounts">0</div>
                    <div class="label">Active accounts</div>
                </div>
                <div class="summary-card">
                    <h3>Total Resources</h3>
                    <div class="amount" id="totalResources">0</div>
                    <div class="label">Active resources</div>
                </div>
                <div class="summary-card">
                    <h3>Highest Cost Account</h3>
                    <div class="amount" id="highestCostAccount">-</div>
                    <div class="label" id="highestAccountCost">$0.00</div>
                </div>
            </div>

            <div class="charts-section">
                <h3 style="margin-bottom: 20px; color: #232f3e;">Cost Distribution</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="accountChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h3>Detailed Cost Breakdown</h3>
                </div>
                <table id="costTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(0)">Account</th>
                            <th class="sortable" onclick="sortTable(1)">Service</th>
                            <th class="sortable" onclick="sortTable(2)">Environment</th>
                            <th class="sortable" onclick="sortTable(3)">Resource ID</th>
                            <th class="sortable" onclick="sortTable(4)">Instance Type</th>
                            <th class="sortable" onclick="sortTable(5)">Daily Cost</th>
                            <th class="sortable" onclick="sortTable(6)">Monthly Cost</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Embedded data (eliminates CORS issues)
        const EMBEDDED_MANIFEST = {"generated_at": "2025-06-17T06:19:34.659927", "accounts": [{"account_id": "534406390912", "account_name": "Account 534406390912", "region": "ap-southeast-2", "scan_time": "2025-06-17T06:19:33.228756", "estimation_time": "2025-06-17T06:19:34.656206", "file_name": "534406390912.json", "total_monthly_cost": 552.384, "resource_count": 12}]};
        
        const EMBEDDED_ACCOUNT_DATA = {"534406390912": {"account_id": "534406390912", "account_name": "Account 534406390912", "region": "ap-southeast-2", "scan_time": "2025-06-17T06:19:33.228756", "estimation_time": "2025-06-17T06:19:34.656206", "currency": "USD", "config_last_updated": "2025-06-17T16:18:28.879906", "summary": [{"service": "EC2", "environment": "unknown", "resource_count": 10, "daily_cost": 14.38, "monthly_cost": 431.42, "currency": "USD"}, {"service": "RDS", "environment": "unknown", "resource_count": 2, "daily_cost": 4.03, "monthly_cost": 120.96, "currency": "USD"}, {"service": "TOTAL", "environment": "ALL", "resource_count": 12, "daily_cost": 18.41, "monthly_cost": 552.38, "currency": "USD"}], "detailed": [{"service": "EC2", "resource_id": "i-03ad60a02a3f6267c", "instance_type": "t2.micro", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0146, "daily_cost": 0.3504, "monthly_cost": 10.512, "currency": "USD"}, {"service": "EC2", "resource_id": "i-0d1b194cfaaec09ad", "instance_type": "t2.micro", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0146, "daily_cost": 0.3504, "monthly_cost": 10.512, "currency": "USD"}, {"service": "EC2", "resource_id": "i-0773bc163483f0c81", "instance_type": "t2.medium", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0584, "daily_cost": 1.4016, "monthly_cost": 42.048, "currency": "USD"}, {"service": "EC2", "resource_id": "i-06d4f6e20e0ce75ff", "instance_type": "t2.xlarge", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.2336, "daily_cost": 5.6064, "monthly_cost": 168.192, "currency": "USD"}, {"service": "EC2", "resource_id": "i-03d324c2966451b0c", "instance_type": "t2.small", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0292, "daily_cost": 0.7008, "monthly_cost": 21.024, "currency": "USD"}, {"service": "EC2", "resource_id": "i-073409690b1333f1b", "instance_type": "t3.large", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.1056, "daily_cost": 2.5343999999999998, "monthly_cost": 76.032, "currency": "USD"}, {"service": "EC2", "resource_id": "i-0dbe6ae5e21d053a9", "instance_type": "t3.small", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0264, "daily_cost": 0.6335999999999999, "monthly_cost": 19.008, "currency": "USD"}, {"service": "EC2", "resource_id": "i-004f01a439f80ab66", "instance_type": "t2.small", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0292, "daily_cost": 0.7008, "monthly_cost": 21.024, "currency": "USD"}, {"service": "EC2", "resource_id": "i-0509dcd40a6d931ab", "instance_type": "t2.medium", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0584, "daily_cost": 1.4016, "monthly_cost": 42.048, "currency": "USD"}, {"service": "EC2", "resource_id": "i-00b5d66eb38457366", "instance_type": "t2.small", "environment": "unknown", "type": "Managed", "in_asg": false, "asg_name": null, "hourly_cost": 0.0292, "daily_cost": 0.7008, "monthly_cost": 21.024, "currency": "USD"}, {"service": "RDS", "resource_id": "maindb", "instance_type": "db.t3.medium", "environment": "unknown", "engine": "postgres", "multi_az": false, "storage_type": "gp2", "hourly_cost": 0.112, "daily_cost": 2.688, "monthly_cost": 80.64, "currency": "USD"}, {"service": "RDS", "resource_id": "urm-production", "instance_type": "db.t3.small", "environment": "unknown", "engine": "postgres", "multi_az": false, "storage_type": "gp3", "hourly_cost": 0.056, "daily_cost": 1.344, "monthly_cost": 40.32, "currency": "USD"}]}};
        
        // Global variables
        let allAccountData = [];
        let filteredData = [];
        let currentSort = { column: -1, ascending: true };

        // Service color mapping
        const SERVICE_COLORS = {
            'EC2': {
                primary: '#FF9900',    // AWS Orange
                secondary: '#E68900'
            },
            'RDS': {
                primary: '#146EB4',    // AWS Blue
                secondary: '#0F5A96'
            },
            'EKS': {
                primary: '#232F3E',    // AWS Dark Blue
                secondary: '#1A252F'
            },
            'ELB': {
                primary: '#43A047',    // Green
                secondary: '#2E7D32'
            },
            'S3': {
                primary: '#9C27B0',    // Purple
                secondary: '#7B1FA2'
            },
            'Lambda': {
                primary: '#FF5722',    // Deep Orange
                secondary: '#D84315'
            },
            'default': {
                primary: '#757575',    // Grey
                secondary: '#424242'
            }
        };

        function getServiceColor(service, type = 'primary') {
            return SERVICE_COLORS[service]?.[type] || SERVICE_COLORS.default[type];
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        function loadDashboardData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dashboardData = document.getElementById('dashboardData');
            
            loadingIndicator.classList.remove('hidden');
            dashboardData.classList.add('hidden');
            
            try {
                // Load data from embedded sources
                allAccountData = [];
                
                // Validate embedded data
                if (!EMBEDDED_MANIFEST) {
                    throw new Error('Embedded manifest data not found');
                }
                
                if (!EMBEDDED_MANIFEST.accounts || !Array.isArray(EMBEDDED_MANIFEST.accounts)) {
                    throw new Error('Invalid manifest accounts data');
                }
                
                if (!EMBEDDED_ACCOUNT_DATA) {
                    throw new Error('Embedded account data not found');
                }
                
                // Load data from each account in the manifest
                EMBEDDED_MANIFEST.accounts.forEach(account => {
                    const accountId = account.account_id;
                    if (EMBEDDED_ACCOUNT_DATA[accountId] && accountId !== 'unknown') {
                        allAccountData.push(EMBEDDED_ACCOUNT_DATA[accountId]);
                    }
                });
                
                if (allAccountData.length === 0) {
                    throw new Error('No valid account data found. Please generate reports first.');
                }
                
                populateFilters();
                updateSummary();
                updateCharts();
                updateTable();
                
                loadingIndicator.classList.add('hidden');
                dashboardData.classList.remove('hidden');
                
            } catch (error) {
                console.error('Dashboard loading error:', error);
                loadingIndicator.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }


        function populateFilters() {
            const accountFilter = document.getElementById('accountFilter');
            const environmentFilter = document.getElementById('environmentFilter');
            
            // Clear existing options (except "All")
            accountFilter.innerHTML = '<option value="all">All Accounts (Aggregated)</option>';
            environmentFilter.innerHTML = '<option value="all">All Environments</option>';
            
            const uniqueEnvironments = new Set();
            
            // Populate account filter and collect environments
            allAccountData.forEach(account => {
                const option = document.createElement('option');
                option.value = account.account_id;
                option.textContent = `${account.account_name || account.account_id} (${account.region})`;
                accountFilter.appendChild(option);
                
                // Collect unique environments
                account.detailed.forEach(resource => {
                    uniqueEnvironments.add(resource.environment);
                });
            });
            
            // Populate environment filter
            Array.from(uniqueEnvironments).sort().forEach(env => {
                const option = document.createElement('option');
                option.value = env;
                option.textContent = env;
                environmentFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const accountFilter = document.getElementById('accountFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const environmentFilter = document.getElementById('environmentFilter').value;
            const costThreshold = parseFloat(document.getElementById('costThreshold').value) || 0;
            
            // Filter data based on selections
            filteredData = [];
            
            const accountsToProcess = accountFilter === 'all' ? allAccountData : 
                allAccountData.filter(account => account.account_id === accountFilter);
            
            accountsToProcess.forEach(account => {
                account.detailed.forEach(resource => {
                    let include = true;
                    
                    if (serviceFilter !== 'all' && resource.service !== serviceFilter) {
                        include = false;
                    }
                    
                    if (environmentFilter !== 'all' && resource.environment !== environmentFilter) {
                        include = false;
                    }
                    
                    if (resource.monthly_cost < costThreshold) {
                        include = false;
                    }
                    
                    if (include) {
                        filteredData.push({
                            ...resource,
                            account_id: account.account_id,
                            account_name: account.account_name || account.account_id,
                            region: account.region
                        });
                    }
                });
            });
            
            updateSummary();
            updateCharts();
            updateTable();
        }

        function clearFilters() {
            document.getElementById('accountFilter').value = 'all';
            document.getElementById('serviceFilter').value = 'all';
            document.getElementById('environmentFilter').value = 'all';
            document.getElementById('costThreshold').value = '';
            
            applyFilters();
        }

        function updateSummary() {
            const dataToUse = filteredData.length > 0 ? filteredData : 
                allAccountData.flatMap(account => account.detailed.map(resource => ({
                    ...resource,
                    account_id: account.account_id,
                    account_name: account.account_name || account.account_id
                })));
            
            const totalCost = dataToUse.reduce((sum, resource) => sum + resource.monthly_cost, 0);
            const uniqueAccounts = new Set(dataToUse.map(resource => resource.account_id));
            const totalResources = dataToUse.length;
            
            // Find highest cost account
            const accountCosts = {};
            dataToUse.forEach(resource => {
                accountCosts[resource.account_id] = (accountCosts[resource.account_id] || 0) + resource.monthly_cost;
            });
            
            const highestAccount = Object.entries(accountCosts).reduce((max, [accountId, cost]) => 
                cost > max.cost ? { accountId, cost } : max, { accountId: '', cost: 0 });
            
            document.getElementById('totalMonthlyCost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('totalAccounts').textContent = uniqueAccounts.size;
            document.getElementById('totalResources').textContent = totalResources;
            document.getElementById('highestCostAccount').textContent = highestAccount.accountId || '-';
            document.getElementById('highestAccountCost').textContent = `$${highestAccount.cost.toFixed(2)}`;
        }

        function updateCharts() {
            const dataToUse = filteredData.length > 0 ? filteredData : 
                allAccountData.flatMap(account => account.detailed.map(resource => ({
                    ...resource,
                    account_id: account.account_id,
                    account_name: account.account_name || account.account_id
                })));
            
            // Account distribution chart
            const accountCosts = {};
            dataToUse.forEach(resource => {
                const key = resource.account_name || resource.account_id;
                accountCosts[key] = (accountCosts[key] || 0) + resource.monthly_cost;
            });
            
            updateAccountChart(accountCosts);
            
            // Service distribution chart
            const serviceCosts = {};
            dataToUse.forEach(resource => {
                serviceCosts[resource.service] = (serviceCosts[resource.service] || 0) + resource.monthly_cost;
            });
            
            updateServiceChart(serviceCosts);
        }

        function updateAccountChart(accountCosts) {
            const ctx = document.getElementById('accountChart').getContext('2d');
            
            if (window.accountChart && typeof window.accountChart.destroy === 'function') {
                window.accountChart.destroy();
            }
            
            // Use AWS brand colors for accounts
            const accountColors = [
                '#FF9900', '#232F3E', '#146EB4', '#43A047', '#E53935',
                '#FF5722', '#9C27B0', '#3F51B5', '#00BCD4', '#4CAF50'
            ];
            
            window.accountChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(accountCosts),
                    datasets: [{
                        data: Object.values(accountCosts),
                        backgroundColor: accountColors,
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost by Account'
                        },
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateServiceChart(serviceCosts) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            
            if (window.serviceChart && typeof window.serviceChart.destroy === 'function') {
                window.serviceChart.destroy();
            }
            
            // Generate colors for each service
            const services = Object.keys(serviceCosts);
            const backgroundColors = services.map(service => getServiceColor(service, 'primary'));
            const borderColors = services.map(service => getServiceColor(service, 'secondary'));
            
            window.serviceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: services,
                    datasets: [{
                        label: 'Monthly Cost',
                        data: Object.values(serviceCosts),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost by Service'
                        },
                        legend: {
                            display: false // Hide legend since colors represent services directly
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const dataToUse = filteredData.length > 0 ? filteredData : 
                allAccountData.flatMap(account => account.detailed.map(resource => ({
                    ...resource,
                    account_id: account.account_id,
                    account_name: account.account_name || account.account_id
                })));
            
            const tbody = document.getElementById('costTableBody');
            tbody.innerHTML = '';
            
            // Sort data if needed
            let sortedData = [...dataToUse];
            if (currentSort.column >= 0) {
                sortedData = sortTableData(sortedData, currentSort.column, currentSort.ascending);
            }
            
            sortedData.forEach(resource => {
                const row = tbody.insertRow();
                const serviceClass = SERVICE_COLORS[resource.service] ? resource.service : 'default';
                row.innerHTML = `
                    <td><span class="account-badge">${resource.account_name}</span></td>
                    <td><span class="service-badge ${serviceClass}">${resource.service}</span></td>
                    <td><span class="environment-badge">${resource.environment}</span></td>
                    <td>${resource.resource_id}</td>
                    <td>${resource.instance_type}</td>
                    <td>$${resource.daily_cost.toFixed(2)}</td>
                    <td>$${resource.monthly_cost.toFixed(2)}</td>
                `;
            });
        }

        function sortTable(columnIndex) {
            const headers = document.querySelectorAll('#costTable th.sortable');
            
            // Toggle sort direction
            if (currentSort.column === columnIndex) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = columnIndex;
                currentSort.ascending = true;
            }
            
            // Update header appearance
            headers.forEach((header, index) => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (index === columnIndex) {
                    header.classList.add(currentSort.ascending ? 'sort-asc' : 'sort-desc');
                }
            });
            
            updateTable();
        }

        function sortTableData(data, columnIndex, ascending) {
            return data.sort((a, b) => {
                let aValue, bValue;
                
                switch (columnIndex) {
                    case 0: // Account
                        aValue = a.account_name;
                        bValue = b.account_name;
                        break;
                    case 1: // Service
                        aValue = a.service;
                        bValue = b.service;
                        break;
                    case 2: // Environment
                        aValue = a.environment;
                        bValue = b.environment;
                        break;
                    case 3: // Resource ID
                        aValue = a.resource_id;
                        bValue = b.resource_id;
                        break;
                    case 4: // Instance Type
                        aValue = a.instance_type;
                        bValue = b.instance_type;
                        break;
                    case 5: // Daily Cost
                        aValue = a.daily_cost;
                        bValue = b.daily_cost;
                        break;
                    case 6: // Monthly Cost
                        aValue = a.monthly_cost;
                        bValue = b.monthly_cost;
                        break;
                    default:
                        return 0;
                }
                
                // Handle numeric values
                if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return ascending ? aValue - bValue : bValue - aValue;
                }
                
                // Handle string values
                aValue = String(aValue).toLowerCase();
                bValue = String(bValue).toLowerCase();
                
                if (aValue < bValue) return ascending ? -1 : 1;
                if (aValue > bValue) return ascending ? 1 : -1;
                return 0;
            });
        }

        function exportData() {
            const dataToUse = filteredData.length > 0 ? filteredData : 
                allAccountData.flatMap(account => account.detailed.map(resource => ({
                    ...resource,
                    account_id: account.account_id,
                    account_name: account.account_name || account.account_id
                })));
            
            // Create CSV content
            const headers = ['Account', 'Service', 'Environment', 'Resource ID', 'Instance Type', 'Daily Cost', 'Monthly Cost'];
            const csvContent = [
                headers.join(','),
                ...dataToUse.map(resource => [
                    `"${resource.account_name}"`,
                    resource.service,
                    resource.environment,
                    `"${resource.resource_id}"`,
                    resource.instance_type,
                    resource.daily_cost.toFixed(2),
                    resource.monthly_cost.toFixed(2)
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aws-cost-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize filters on load
        applyFilters();
    </script>
</body>
</html>